<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeFi‑RealEstate — Admin</title>
<meta name="description" content="Admin demo to add and manage mock real estate listings stored locally for the Marketplace page.">
<!-- Critical CSS for quick first paint; full stylesheet loads asynchronously below -->
<style>
  :root{--bg:#0b0d12;--card:#111623;--text:#e9eef5;--muted:#a9b2c2;--primary:#2e7cf6}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif}
  main{padding:16px}
  .card{background:var(--card);border-radius:12px;padding:20px}
  .muted{color:var(--muted)}
  button.primary{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#1b2133;color:#e9eef5;border:1px solid #2a3550;padding:10px 14px;border-radius:8px;cursor:pointer}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px;border-bottom:1px solid #1f2a44}
  @media (max-width:720px){ main{padding:12px} }
  .error{outline:2px solid #e25d5d}
</style>
<link rel="preload" href="assets/style.min.css?v=4" as="style">
<link rel="stylesheet" href="assets/style.min.css?v=4" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="assets/style.min.css?v=4"></noscript>
</head>
<body>



<main>
  <div class="card">
    <h2 data-i18n="a_title">Admin — Add Property (Demo)</h2>
    <p class="muted" data-i18n="a_desc">Add demo listings. They appear in the Marketplace and are stored locally for this session.</p>
    <div class="row-4">
  <div class="field"><label data-i18n="a_address">Address</label><input id="a-address" placeholder="123 Palm Ave, Orlando, FL" autocomplete="street-address" required></div>
  <div class="field"><label data-i18n="a_type">Type</label><select id="a-type" required><option>Single Family</option><option>Condo</option><option>Townhome</option></select></div>
  <div class="field"><label data-i18n="a_price">Price ($)</label><input id="a-price" type="number" step="1000" min="0" required></div>
  <div class="field"><label data-i18n="a_cap">Cap Rate (%)</label><input id="a-cap" type="number" step="0.1" min="0" max="100" value="5.5" required></div>
  <div class="field"><label data-i18n="a_beds">Beds</label><input id="a-beds" type="number" step="1" min="0" required></div>
  <div class="field"><label data-i18n="a_baths">Baths</label><input id="a-baths" type="number" step="1" min="0" required></div>
  <div class="field"><label data-i18n="a_sqft">Sqft</label><input id="a-sqft" type="number" step="50" min="0" required></div>
  <div class="field"><label data-i18n="a_raise">Total Raise ($)</label><input id="a-raise" type="number" step="1000" min="0" required></div>
  <div class="field"><label data-i18n="a_img">Image URL</label><input id="a-img" placeholder="https://..." required></div>
  <div class="field" style="grid-column:span 3"><label data-i18n="a_desc_label">Description</label><input id="a-desc" placeholder="Highlights, neighborhood, upgrades..." required></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="primary" id="a-add" data-i18n="add">Add</button>
      <button class="secondary" id="a-cancel" style="display:none" data-i18n="cancel">Cancel</button>
  <button class="secondary" id="a-clear-form" data-i18n="a_clear_form" data-i18n-title="a_clear_form" title="Clear Form">Clear Form</button>
    </div>
  </div>

  <div class="card">
    <h3 data-i18n="a_current">Current Offerings</h3>
    <div id="a-notice" class="notice" style="display:none"></div>
    <table class="table">
  <thead><tr><th class="row-action" data-i18n-aria-label="edit"></th><th data-i18n="t_address">Address</th><th data-i18n="t_price">Price</th><th data-i18n="t_raise">Raise</th><th data-i18n="t_available">Available</th><th data-i18n="t_actions">Actions</th></tr></thead>
      <tbody id="a-tbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 data-i18n="trash_title">Trash (Deleted)</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
  <button id="trash-restore-all" data-i18n="trash_restore_all">Restore All</button>
  <button class="danger" id="trash-empty" data-i18n="trash_empty">Empty Trash</button>
    </div>
    <table class="table">
  <thead><tr><th data-i18n="t_address">Address</th><th data-i18n="t_actions">Actions</th></tr></thead>
      <tbody id="trash-tbody"></tbody>
    </table>
  </div>
</main>




<script src="assets/config.js"></script>
<script src="assets/app.min.js?v=2"></script>
<script src="assets/shared.min.js?v=5"></script>
<script src="assets/i18n-extra.js?v=1"></script>
<script>
injectHeaderFooter("admin");
let listings = getMockListings();
let editingId = null;
let trash = JSON.parse(localStorage.getItem('demo_trash')||'[]');
let lastDeleted = [];
function saveTrash(){ localStorage.setItem('demo_trash', JSON.stringify(trash)); }
// Real-time validity check to enable/disable Add/Save
function isAdminFormValid(){
  const q = (id)=>{ const el=document.getElementById(id); return el ? el.value : ''; };
  const addr = (q('a-address')||'').trim(); if(!addr) return false;
  const typeVal = (q('a-type')||'').trim(); if(!typeVal) return false;
  const priceVal = +(q('a-price')||0); if(!(priceVal>0)) return false;
  const capStr = (q('a-cap')||'').trim(); if(capStr==='') return false; const cap = +capStr; if(isNaN(cap)||cap<0||cap>100) return false;
  const bedsStr = (q('a-beds')||'').trim(); if(bedsStr==='') return false; if(+bedsStr<0) return false;
  const bathsStr = (q('a-baths')||'').trim(); if(bathsStr==='') return false; if(+bathsStr<0) return false;
  const sqftStr = (q('a-sqft')||'').trim(); if(sqftStr==='') return false; if(+sqftStr<0) return false;
  const raiseStr = (q('a-raise')||'').trim(); if(raiseStr==='') return false; if(+raiseStr<=0) return false;
  const imgStr = (q('a-img')||'').trim(); if(!imgStr) return false; if(!/^https?:\/\//i.test(imgStr) && !imgStr.startsWith('data:')) return false;
  const descStr = (q('a-desc')||'').trim(); if(!descStr) return false;
  return true;
}
function updateAddButtonState(){
  const btn = document.getElementById('a-add'); if(!btn) return;
  const ok = isAdminFormValid();
  btn.disabled = !ok;
  btn.setAttribute('aria-disabled', String(!ok));
}
function renderAdminTable(){
  const tb=document.getElementById("a-tbody"); tb.innerHTML="";
  listings.forEach(p=>{
    const tr=document.createElement("tr");
    tr.dataset.id = p.id;
    if (editingId && editingId === p.id) tr.classList.add('editing');
    const isEditing = editingId && editingId === p.id;
  const lang = localStorage.getItem('lang') || 'en';
  const editBtn = isEditing
    ? `<button data-id="${p.id}" data-action="cancel" title="${I18N[lang].cancel_edit}" aria-label="${I18N[lang].cancel_edit}">\u2715</button>`
    : `<button data-id="${p.id}" data-action="edit" title="${I18N[lang].edit}" aria-label="${I18N[lang].edit}" class="icon-btn">\u270f\ufe0f</button>`;
  tr.innerHTML=`<td class=\"row-action\">${editBtn}</td><td>${p.address}</td><td>${formatMoney(p.price)}</td><td>${formatMoney(p.totalRaise)}</td><td>${formatMoney(p.availableRaise)}</td><td style=\"display:flex;gap:8px\"><button class=\"danger\" data-id=\"${p.id}\" data-action=\"remove\">${I18N[lang].remove}</button></td>`;
    tb.appendChild(tr);
  });
}
function applyHighlight(){
  const rows = document.querySelectorAll('#a-tbody tr');
  rows.forEach(r=>r.classList.remove('editing'));
  if(editingId){
    const target = document.querySelector(`#a-tbody tr[data-id="${editingId}"]`);
    if(target) target.classList.add('editing');
  }
}
function showUndo(message, items){
  lastDeleted = items || [];
  const n = document.getElementById('a-notice');
  const lang = localStorage.getItem('lang') || 'en';
  n.innerHTML = `${message} <button id="undo-btn">${I18N[lang].undo}</button>`;
  n.style.display = 'block';
  document.getElementById('undo-btn').onclick = ()=>{
    if(lastDeleted && lastDeleted.length){
      // Restore to listings; remove from trash by id
      const ids = new Set(lastDeleted.map(x=>x.id));
      // Avoid duplicates: filter out any existing with same ids
      listings = [...lastDeleted.filter(x=>x && x.id), ...listings.filter(x=>!ids.has(x.id))];
      trash = trash.filter(x=>!ids.has(x.id));
      saveMockListings(listings); saveTrash();
      renderAdminTable(); renderTrashTable();
    }
    n.style.display = 'none'; lastDeleted = [];
  };
}
function fillForm(p){
  const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value = v ?? ''};
  set('a-address', p.address);
  set('a-type', p.type);
  set('a-price', p.price);
  set('a-cap', p.capRate);
  set('a-beds', p.beds);
  set('a-baths', p.baths);
  set('a-sqft', p.sqft);
  set('a-raise', p.totalRaise);
  set('a-img', p.image);
  set('a-desc', p.description);
  // Update button state after programmatic fill
  updateAddButtonState();
}
function clearForm(){ fillForm({address:'',type:'Single Family',price:'',capRate:'',beds:'',baths:'',sqft:'',totalRaise:'',image:'',description:''}); }
function enterEdit(id){
  const p = listings.find(x=>x.id===id); if(!p) return;
  editingId = id;
  fillForm(p);
  const addBtn=document.getElementById('a-add'); addBtn.textContent=I18N[(localStorage.getItem('lang')||'en')].save;
  const cancelBtn=document.getElementById('a-cancel'); cancelBtn.style.display='inline-block';
  renderAdminTable();
  updateAddButtonState();
}
function exitEdit(){ editingId=null; const addBtn=document.getElementById('a-add'); addBtn.textContent=I18N[(localStorage.getItem('lang')||'en')].add; document.getElementById('a-cancel').style.display='none'; renderAdminTable(); clearForm(); updateAddButtonState(); }
document.getElementById("a-add").onclick=()=>{
  // Validate form and highlight errors
  const fs = {
    address: document.getElementById('a-address'),
    type: document.getElementById('a-type'),
    price: document.getElementById('a-price'),
    cap: document.getElementById('a-cap'),
    beds: document.getElementById('a-beds'),
    baths: document.getElementById('a-baths'),
    sqft: document.getElementById('a-sqft'),
    raise: document.getElementById('a-raise'),
    img: document.getElementById('a-img'),
    desc: document.getElementById('a-desc')
  };
  // Clear previous error styling
  Object.values(fs).forEach(el=>{ if(el){ el.classList.remove('error'); el.removeAttribute('aria-invalid'); } });
  const note = document.getElementById('a-notice');
  function aErr(msg, el){ if(note){ note.style.display='block'; note.textContent=msg; note.setAttribute('role','alert'); }
    if(el){ el.classList.add('error'); el.setAttribute('aria-invalid','true'); el.focus(); }
    return;
  }
  const lang = localStorage.getItem('lang') || 'en';
  const addr = (fs.address?.value||'').trim();
  if(!addr){ aErr(I18N[lang].a_err_address_required, fs.address); return; }
  const typeVal = (fs.type?.value||'').trim();
  if(!typeVal){ aErr(I18N[lang].a_err_type_required, fs.type); return; }
  const priceVal = +((fs.price?.value)||0);
  if(!(priceVal>0)){ aErr(I18N[lang].a_err_price_gt0, fs.price); return; }
  const capStr = (fs.cap?.value||'').trim();
  if(capStr===''){ aErr(I18N[lang].a_err_cap_required, fs.cap); return; }
  if(isNaN(+capStr) || +capStr<0 || +capStr>100){ aErr(I18N[lang].a_err_cap_range, fs.cap); return; }
  const bedsStr = (fs.beds?.value||'').trim(); if(bedsStr===''){ aErr(I18N[lang].a_err_beds_required, fs.beds); return; } if(+bedsStr<0){ aErr(I18N[lang].a_err_beds_nonneg, fs.beds); return; }
  const bathsStr = (fs.baths?.value||'').trim(); if(bathsStr===''){ aErr(I18N[lang].a_err_baths_required, fs.baths); return; } if(+bathsStr<0){ aErr(I18N[lang].a_err_baths_nonneg, fs.baths); return; }
  const sqftStr = (fs.sqft?.value||'').trim(); if(sqftStr===''){ aErr(I18N[lang].a_err_sqft_required, fs.sqft); return; } if(+sqftStr<0){ aErr(I18N[lang].a_err_sqft_nonneg, fs.sqft); return; }
  const raiseStr = (fs.raise?.value||'').trim(); if(raiseStr===''){ aErr(I18N[lang].a_err_raise_required, fs.raise); return; } if(+raiseStr<=0){ aErr(I18N[lang].a_err_raise_gt0, fs.raise); return; }
  const imgStr = (fs.img?.value||'').trim();
  if(!imgStr){ aErr(I18N[lang].a_err_img_required, fs.img); return; }
  if(!/^https?:\/\//i.test(imgStr) && !imgStr.startsWith('data:')){ aErr(I18N[lang].a_err_img_format, fs.img); return; }
  const descStr = (fs.desc?.value||'').trim(); if(!descStr){ aErr(I18N[lang].a_err_desc_required, fs.desc); return; }

  const g=id=>document.getElementById(id).value;
  const price=priceVal, raise=+(raiseStr||0);
  if(editingId){
    const idx=listings.findIndex(x=>x.id===editingId); if(idx<0) return;
  let available = listings[idx].availableRaise;
  const newTotal = raise;
    if(available > newTotal) available = newTotal;
    const updated={
      ...listings[idx],
      address:g('a-address'), type:g('a-type'), price,
      capRate:+g('a-cap')||null, beds:+g('a-beds')||0, baths:+g('a-baths')||0, sqft:+g('a-sqft')||0,
      totalRaise:newTotal, availableRaise:available, image:g('a-img'), description:g('a-desc')
    };
  listings[idx]=updated; saveMockListings(listings); renderAdminTable();
  const noteOK=document.getElementById('a-notice'); if(noteOK){ noteOK.style.display='none'; noteOK.textContent=''; }
  exitEdit();
  } else {
    const id="P-"+Math.random().toString(36).slice(2,7).toUpperCase();
  const p={id,ts:Date.now(),address:g("a-address"),type:g("a-type"),price,
             beds:+g("a-beds")||0,baths:+g("a-baths")||0,sqft:+g("a-sqft")||0,
       capRate:+g("a-cap")||null,totalRaise:raise,
       availableRaise:raise,image:g("a-img"),
             description:g("a-desc"),sourceUrl:"#"};
  listings.unshift(p); saveMockListings(listings); renderAdminTable();
  const noteOK=document.getElementById('a-notice'); if(noteOK){ noteOK.style.display='none'; noteOK.textContent=''; }
  clearForm();
  updateAddButtonState();
  }
};
// Clear error highlighting as user edits fields
function clearAdminFieldError(el){ if(!el) return; el.classList.remove('error'); el.removeAttribute('aria-invalid'); const n=document.getElementById('a-notice'); if(n){ n.style.display='none'; n.textContent=''; } }
["a-address","a-type","a-price","a-cap","a-beds","a-baths","a-sqft","a-raise","a-img","a-desc"].forEach(id=>{
  const el=document.getElementById(id); if(!el) return; const evt = el.tagName === 'SELECT' ? 'change' : 'input';
  el.addEventListener(evt, ()=>{ clearAdminFieldError(el); updateAddButtonState(); });
});
document.getElementById('a-cancel').onclick=exitEdit;
document.getElementById('a-clear-form').onclick=()=>{ exitEdit(); clearForm(); };
document.getElementById("a-tbody").addEventListener("click",e=>{
  const t = e.target;
  const actBtn = (t && t.closest) ? t.closest("button[data-action]") : (t && t.parentElement && t.parentElement.closest ? t.parentElement.closest("button[data-action]") : null);
  if(!actBtn) return;
  const id=actBtn.getAttribute("data-id");
  const action=actBtn.getAttribute("data-action");
  if(action==='remove'){
    const it = listings.find(x=>x.id===id);
    const addr = it && it.address ? it.address : id;
    const lang = localStorage.getItem('lang') || 'en';
    const tmpl = I18N[lang] && I18N[lang].a_confirm_remove ? I18N[lang].a_confirm_remove : 'Remove this listing?\n{addr}';
    const msg = tmpl.replace('{addr}', addr);
    if(!confirm(msg)) return;
    if(editingId===id) { exitEdit(); }
    // Move to trash for recovery
  if(it){ trash.unshift(it); saveTrash(); showUndo(I18N[(localStorage.getItem('lang')||'en')].listing_removed, [it]); }
    listings=listings.filter(x=>x.id!==id); saveMockListings(listings); renderAdminTable(); renderTrashTable();
  } else if(action==='edit'){
    enterEdit(id);
  } else if(action==='cancel'){
    exitEdit();
  }
});
function renderTrashTable(){
  const tb=document.getElementById('trash-tbody'); if(!tb) return; tb.innerHTML='';
  trash.forEach(p=>{
    const tr=document.createElement('tr');
    const lang = localStorage.getItem('lang') || 'en';
    tr.innerHTML = `<td>${p.address || p.id}</td><td><button data-id="${p.id}" data-action="restore">${I18N[lang].trash_restore}</button></td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('trash-restore-all').onclick=()=>{
  if(!trash.length) return;
  listings = [...trash, ...listings];
  const restoredIds = new Set(trash.map(x=>x.id));
  // Ensure uniqueness
  listings = listings.filter((x,i,self)=> x && x.id && self.findIndex(y=>y.id===x.id)===i);
  trash = []; saveMockListings(listings); saveTrash();
  renderAdminTable(); renderTrashTable();
};
document.getElementById('trash-empty').onclick=()=>{
  if(!trash.length) return;
  const lang2 = localStorage.getItem('lang') || 'en';
  if(confirm(I18N[lang2].trash_empty_confirm)){ trash = []; saveTrash(); renderTrashTable(); }
};
document.getElementById('trash-tbody').addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('button[data-action="restore"]'); if(!btn) return;
  const id = btn.getAttribute('data-id');
  const idx = trash.findIndex(x=>x.id===id);
  if(idx>-1){
    const item = trash.splice(idx,1)[0];
    listings.unshift(item); saveMockListings(listings); saveTrash();
    renderAdminTable(); renderTrashTable();
  }
});
renderAdminTable();
renderTrashTable();
// Initialize disabled state on load
updateAddButtonState();

// Optional: Google Places Autocomplete for Address
// To enable, serve with an API key restricted to Places Autocomplete and your domain.
// Add your key below or set window.GOOGLE_PLACES_KEY before this script runs.
(function(){
  const KEY = window.GOOGLE_PLACES_KEY || '';
  if(!KEY) return; // No key provided, skip
  const s=document.createElement('script');
  s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(KEY)}&libraries=places&callback=__dreInitPlaces`;
  s.async=true; s.defer=true; document.head.appendChild(s);
  window.__dreInitPlaces = function(){
    const input=document.getElementById('a-address'); if(!input || !window.google || !google.maps || !google.maps.places) return;
    try{
      const country = window.GOOGLE_PLACES_COUNTRY || 'us';
      const ac = new google.maps.places.Autocomplete(input, {
        types: ['address'],
        fields: ['address_components','formatted_address'],
        componentRestrictions: country ? { country } : undefined
      });
      ac.addListener('place_changed', ()=>{
        const place = ac.getPlace();
        if(place && place.formatted_address){
          input.value = place.formatted_address;
          clearAdminFieldError && clearAdminFieldError(input);
          const comps = place.address_components || [];
          const getLong = (t)=>{ const c = comps.find(x=>x.types && x.types.indexOf(t)>=0); return c? c.long_name: ''; };
          const getShort = (t)=>{ const c = comps.find(x=>x.types && x.types.indexOf(t)>=0); return c? c.short_name: ''; };
          const city = getLong('locality') || getLong('sublocality') || getLong('postal_town');
          const state = getShort('administrative_area_level_1');
          const zip = getLong('postal_code');
          const cityEl = document.getElementById('a-city'); if(cityEl){ cityEl.value = city; clearAdminFieldError && clearAdminFieldError(cityEl); }
          const stateEl = document.getElementById('a-state'); if(stateEl){ stateEl.value = state; clearAdminFieldError && clearAdminFieldError(stateEl); }
          const zipEl = document.getElementById('a-zip'); if(zipEl){ zipEl.value = zip; clearAdminFieldError && clearAdminFieldError(zipEl); }
          updateAddButtonState && updateAddButtonState();
        }
      });
    }catch(e){ /* fail silently */ }
  };
})();
</script>
</body>
</html>
