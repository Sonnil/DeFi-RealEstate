<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeFi‑RealEstate — Admin</title>
<meta name="description" content="Admin to add and manage real estate listings stored locally for the Marketplace page.">
<!-- Critical CSS for quick first paint; full stylesheet loads asynchronously below -->
<style>
  :root{--bg:#0b0d12;--card:#111623;--text:#e9eef5;--muted:#a9b2c2;--primary:#2e7cf6}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif}
  main{padding:16px}
  .card{background:var(--card);border-radius:12px;padding:20px}
  .muted{color:var(--muted)}
  button.primary{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#1b2133;color:#e9eef5;border:1px solid #2a3550;padding:10px 14px;border-radius:8px;cursor:pointer}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px;border-bottom:1px solid #1f2a44}
  /* Modal styles */
  .modal{position:fixed;inset:0;display:none;z-index:10000}
  .modal.open{display:block}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
  .modal .panel{position:relative;background:var(--card);border:1px solid #23314d;color:var(--text);width:min(880px,92vw);max-height:90vh;overflow:auto;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.5);margin:6vh auto;padding:16px}
  .modal .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){ .two-col{grid-template-columns:1fr} }
  @media (max-width:720px){ main{padding:12px} }
  .icon-btn{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:0 2px}
  .icon-btn:hover{color:#fff}
  /* Close (X) button styling in modal header */
  .close-x{font-size:20px;line-height:1;border:0;background:transparent;color:var(--muted);cursor:pointer;padding:6px 8px;border-radius:8px}
  .close-x:hover{color:#fff;background:#1b2133}
  /* Tooltip bubble (local) */
  .tooltip{position:relative;display:inline-block}
  .tooltip .tip{position:absolute;z-index:1000;left:50%;transform:translateX(-50%);bottom:125%;background:#0e1526;color:#e9eef5;border:1px solid #2a3550;border-radius:8px;padding:8px 10px;white-space:normal;font-size:12px;line-height:1.3;min-width:180px;max-width:260px;box-shadow:0 10px 30px rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .16s ease,transform .16s ease}
  .tooltip .tip::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);border-width:6px;border-style:solid;border-color:#0e1526 transparent transparent transparent}
  .tooltip:hover .tip,.tooltip:focus-within .tip,.tooltip.show .tip{opacity:1;pointer-events:auto;transform:translate(-50%,-2px)}
  .tooltip .tip [role="heading"]{font-weight:600;margin:0 0 4px}
  @media (prefers-reduced-motion: reduce){ .tooltip .tip{transition:none} }
  /* Keep expanded submissions within the card frame */
  .sub-row td{ padding: 0 !important; }
  .sub-box{ margin:8px 0; background:var(--card); border:1px solid #1f2a44; border-radius:10px; padding:10px; font-size: clamp(12px, 1.1vw + 0.5rem, 14px) }
  .sub-box table{ width:100%; border-collapse:collapse; table-layout: fixed }
  .sub-box table th, .sub-box table td{ border-bottom:0; padding:6px 8px; vertical-align: top; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  /* Amount column: left-aligned, no wrap */
  .sub-box table th:nth-child(4), .sub-box table td:nth-child(4){ white-space: nowrap; text-align: left; }
</style>
<link rel="preload" href="assets/style.min.css?v=6" as="style">
<link rel="stylesheet" href="assets/style.min.css?v=6" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="assets/style.min.css?v=6"></noscript>
</head>
<body>



<main>
  <div class="card">
  <h2 data-i18n="a_title">Admin — Add Property</h2>
  <p class="muted" data-i18n="a_desc">Add listings. They appear in the Marketplace and are stored locally for this session.</p>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="primary" id="a-open" data-i18n="add">Add</button>
    </div>
  </div>

  <div class="card">
    <h3 data-i18n="a_current">Current Offerings</h3>
    <div id="a-notice" class="notice" style="display:none"></div>
    <table class="table">
      <thead>
        <tr>
          <th class="row-action" data-i18n-aria-label="edit"></th>
          <th data-i18n="t_address">Address</th>
          <th data-i18n="t_price">Price</th>
          <th data-i18n="t_raise">Raise</th>
          <th data-i18n="t_actual_available">Actual Available</th>
          <th data-i18n="t_actions">Actions</th>
        </tr>
      </thead>
      <tbody id="a-tbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 data-i18n="trash_title">Trash (Deleted)</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
  <button id="trash-restore-all" data-i18n="trash_restore_all">Restore All</button>
  <button class="danger" id="trash-empty" data-i18n="trash_empty">Empty Trash</button>
    </div>
    <table class="table">
  <thead><tr><th data-i18n="t_address">Address</th><th data-i18n="t_actions">Actions</th></tr></thead>
      <tbody id="trash-tbody"></tbody>
    </table>
  </div>
</main>


<!-- Admin Modal: Add/Edit Property -->
<div id="a-modal" class="modal" aria-hidden="true">
  <div class="backdrop" id="a-modal-backdrop"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="a-modal-title">
    <div class="hdr">
  <h3 id="a-modal-title" data-i18n="a_title">Admin — Update Property</h3>
      <button class="icon-btn close-x" id="a-cancel" aria-label="Close" data-i18n-aria-label="cancel" title="Close">✕</button>
    </div>
    <div class="two-col">
      <div class="field"><label data-i18n="a_address">Address</label><input id="a-address" placeholder="123 Palm Ave, Orlando, FL" autocomplete="street-address" required></div>
      <div class="field"><label data-i18n="a_type">Type</label><select id="a-type" required><option>Single Family</option><option>Condo</option><option>Townhome</option></select></div>
      <div class="field"><label data-i18n="a_price">Price ($)</label> 
        <span class="tooltip">
          <button type="button" class="icon-btn" aria-label="What is Price?" data-i18n-aria-label="info_price_label">ℹ️</button>
          <span class="tip" role="tooltip"><span role="heading" data-i18n="info_price_label">What is Price?</span><span data-i18n="info_price">The estimated purchase price or offering price for the property.</span></span>
        </span>
        <input id="a-price" type="number" step="1000" min="0" required>
      </div>
      <div class="field"><label data-i18n="a_cap">Cap Rate (%)</label>
        <span class="tooltip">
          <button type="button" class="icon-btn" aria-label="What is Cap Rate?" data-i18n-aria-label="info_cap_label">ℹ️</button>
          <span class="tip" role="tooltip"><span role="heading" data-i18n="info_cap_label">What is Cap Rate?</span><span data-i18n="info_cap">Cap rate = Net Operating Income (NOI) ÷ Purchase Price. Rough annual yield before financing and taxes.</span></span>
        </span>
        <input id="a-cap" type="number" step="0.1" min="0" max="100" value="5.5" required>
      </div>
      <div class="field"><label data-i18n="a_beds">Beds</label><input id="a-beds" type="number" step="1" min="0" required></div>
      <div class="field"><label data-i18n="a_baths">Baths</label><input id="a-baths" type="number" step="1" min="0" required></div>
      <div class="field"><label data-i18n="a_sqft">Sqft</label><input id="a-sqft" type="number" step="50" min="0" required></div>
    <div class="field"><label data-i18n="a_raise">Total Raise ($)</label><input id="a-raise" type="number" step="1000" min="0" required></div>
  <div class="field"><label data-i18n="a_actual_available">Actual Available ($)</label><input id="a-actual" type="number" step="1000" min="0" disabled><small class="muted" data-i18n="a_actual_hint">Auto: 49% of Price minus committed</small></div>
      <div class="field"><label data-i18n="a_img">Image URL</label><input id="a-img" placeholder="https://..." required></div>
      <div class="field" style="grid-column:span 2"><label data-i18n="a_desc_label">Description</label><input id="a-desc" placeholder="Highlights, neighborhood, upgrades..." required></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end">
      <button class="secondary" id="a-clear-form" data-i18n="a_clear_form" data-i18n-title="a_clear_form" title="Clear Form">Clear Form</button>
      <button class="primary" id="a-add" data-i18n="add">Add</button>
    </div>
  </div>
  </div>




<script src="assets/app.min.js?v=7"></script>
<script src="assets/shared.min.js?v=6"></script>
<script src="assets/i18n-extra.js?v=4"></script>
<script>
injectHeaderFooter("admin");
let listings = getMockListings();
// Normalize: if a property has no submissions, reset its totalRaise to 0
try{
  if(Array.isArray(listings)){
    listings = listings.map(function(p){
      var inv = (p && Array.isArray(p.investments)) ? p.investments : [];
      if(!inv.length){ var copy = Object.assign({}, p); copy.totalRaise = 0; return copy; }
      return p;
    });
    if(typeof saveMockListings === 'function') saveMockListings(listings);
  }
}catch(e){}
let editingId = null;
let trash = JSON.parse(localStorage.getItem('demo_trash')||'[]');
let lastDeleted = [];
function saveTrash(){ localStorage.setItem('demo_trash', JSON.stringify(trash)); }
// Real-time validity check to enable/disable Add/Save
function isAdminFormValid(){
  const q = (id)=>{ const el=document.getElementById(id); return el ? el.value : ''; };
  const addr = (q('a-address')||'').trim(); if(!addr) return false;
  const typeVal = (q('a-type')||'').trim(); if(!typeVal) return false;
  const priceVal = +(q('a-price')||0); if(!(priceVal>0)) return false;
  const capStr = (q('a-cap')||'').trim(); if(capStr==='') return false; const cap = +capStr; if(isNaN(cap)||cap<0||cap>100) return false;
  const bedsStr = (q('a-beds')||'').trim(); if(bedsStr==='') return false; if(+bedsStr<0) return false;
  const bathsStr = (q('a-baths')||'').trim(); if(bathsStr==='') return false; if(+bathsStr<0) return false;
  const sqftStr = (q('a-sqft')||'').trim(); if(sqftStr==='') return false; if(+sqftStr<0) return false;
  const raiseStr = (q('a-raise')||'').trim(); if(raiseStr==='') return false; if(+raiseStr<=0) return false;
  const maxRaise = priceVal*0.49; if(+raiseStr>maxRaise) return false;
  const imgStr = (q('a-img')||'').trim(); if(!imgStr) return false; if(!/^https?:\/\//i.test(imgStr) && !imgStr.startsWith('data:')) return false;
  const descStr = (q('a-desc')||'').trim(); if(!descStr) return false;
  return true;
}
// Enable/disable the Add/Save button based on current form validity
function updateAddButtonState(){
  try{
    var btn = document.getElementById('a-add');
    if(!btn) return;
    var ok = !!isAdminFormValid();
    btn.disabled = !ok;
    btn.setAttribute('aria-disabled', String(!ok));
  }catch(e){}
}
function renderAdminTable(){
  const tb=document.getElementById("a-tbody"); tb.innerHTML="";
  const lang = localStorage.getItem('lang') || 'en';
  listings.forEach(p=>{
    const main=document.createElement('tr');
    main.dataset.id = p.id;
    if (editingId && editingId === p.id) main.classList.add('editing');
    const isEditing = editingId && editingId === p.id;
    const editBtn = isEditing
      ? `<button data-id="${p.id}" data-action="cancel" title="${I18N[lang].cancel_edit}" aria-label="${I18N[lang].cancel_edit}">\u2715</button>`
      : `<button data-id="${p.id}" data-action="edit" title="${I18N[lang].edit}" aria-label="${I18N[lang].edit}" class="icon-btn">\u270f\ufe0f</button>`;
    const invs = Array.isArray(p.investments) ? p.investments : [];
    const hasInv = invs.length > 0;
    const subId = `subrow-${p.id}`;
    const toggle = hasInv ? `<button class="secondary" data-id="${p.id}" data-action="toggle-sub" aria-expanded="false" aria-controls="${subId}">${I18N[lang].submissions_toggle}</button>` : `<span class=\"muted\">${I18N[lang].no_submissions}</span>`;
    const committed = (Array.isArray(p.investments) && p.investments.length)
      ? p.investments.reduce((s,x)=> s + ((x.status==='approved')?(+x.amount||0):0), 0)
      : 0;
    const capMax = Math.max(0, Math.floor((+p.price||0) * 0.49));
    const actualAvail = Math.max(0, capMax - committed);
    main.innerHTML = `
      <td class=\"row-action\">${editBtn}</td>
      <td><div style=\"display:flex;align-items:center;gap:8px\"><span>${p.address}</span>${toggle}</div></td>
      <td>${formatMoney(p.price)}</td>
  <td>${formatMoney(p.totalRaise)}</td>
  <td>${formatMoney(actualAvail)}</td>
  <td style=\"display:flex;gap:8px\"><button class=\"danger\" data-id=\"${p.id}\" data-action=\"remove\">${I18N[lang].remove}</button></td>`;
    tb.appendChild(main);

    // Submissions detail row under full width
    const sub=document.createElement('tr');
    sub.id = subId; sub.className='sub-row'; sub.style.display='none';
  const cell=document.createElement('td'); cell.colSpan=6;
    const box=document.createElement('div'); box.className='sub-box'; box.setAttribute('role','region'); box.setAttribute('aria-label', I18N[lang].submissions_label);
    if(hasInv){
      box.innerHTML = `
        <table>
          <colgroup>
            <col style="width:16.6%">
            <col style="width:16.6%">
            <col style="width:16.6%">
            <col style="width:16.6%">
            <col style="width:16.6%">
            <col style="width:8.5%">
            <col style="width:8.5%">
          </colgroup>
          <thead>
            <tr class=\"muted\"><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_name}</th><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_email}</th><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_phone}</th><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_amount}</th><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_time}</th><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_status||'Status'}</th><th style=\"text-align:left;padding:4px 6px\">${I18N[lang].s_actions||'Actions'}</th></tr>
          </thead>
          <tbody>
            ${invs.map((x,i)=>`<tr data-inv-index=\"${i}\">\n              <td title=\"${x.name||''}\" style=\"padding:4px 6px\">${(x.name||'—')}</td>\n              <td title=\"${x.email||''}\" style=\"padding:4px 6px\">${(x.email||'—')}</td>\n              <td title=\"${x.phone||''}\" style=\"padding:4px 6px\">${(x.phone||'—')}</td>\n              <td title=\"${formatMoney(+x.amount||0)}\" style=\"padding:4px 6px\">${formatMoney(+x.amount||0)}</td>\n              <td title=\"${new Date(x.ts||Date.now()).toLocaleString()}\" style=\"padding:4px 6px\">${new Date(x.ts||Date.now()).toLocaleString()}</td>\n              <td title=\"${x.status==='approved' ? (I18N[lang].status_approved||'Approved') : (I18N[lang].status_pending||'Pending')}\" style=\"padding:4px 6px\">${x.status==='approved' ? (I18N[lang].status_approved||'Approved') : (I18N[lang].status_pending||'Pending')}</td>\n              <td style=\"padding:4px 6px\">${x.status==='approved' ? '' : `<button data-id='${p.id}' data-action='approve' data-index='${i}'>${I18N[lang].approve||'Approve'}</button>`}</td>\n            </tr>`).join('')}
          </tbody>
        </table>`;
    } else {
      box.textContent = '';
    }
    cell.appendChild(box); sub.appendChild(cell); tb.appendChild(sub);
  });
}
function applyHighlight(){
  const rows = document.querySelectorAll('#a-tbody tr');
  rows.forEach(r=>r.classList.remove('editing'));
  if(editingId){
    const target = document.querySelector(`#a-tbody tr[data-id="${editingId}"]`);
    if(target) target.classList.add('editing');
  }
}
function showUndo(message, items){
  lastDeleted = items || [];
  const n = document.getElementById('a-notice');
  const lang = localStorage.getItem('lang') || 'en';
  n.innerHTML = `${message} <button id="undo-btn">${I18N[lang].undo}</button>`;
  n.style.display = 'block';
  document.getElementById('undo-btn').onclick = ()=>{
    if(lastDeleted && lastDeleted.length){
      // Restore to listings; remove from trash by id
      const ids = new Set(lastDeleted.map(x=>x.id));
      // Avoid duplicates: filter out any existing with same ids
      listings = [...lastDeleted.filter(x=>x && x.id), ...listings.filter(x=>!ids.has(x.id))];
      trash = trash.filter(x=>!ids.has(x.id));
      saveMockListings(listings); saveTrash();
      renderAdminTable(); renderTrashTable();
    }
    n.style.display = 'none'; lastDeleted = [];
  };
}
function fillForm(p){
  const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value = v ?? ''};
  set('a-address', p.address);
  set('a-type', p.type);
  set('a-price', p.price);
  set('a-cap', p.capRate);
  set('a-beds', p.beds);
  set('a-baths', p.baths);
  set('a-sqft', p.sqft);
  set('a-raise', p.totalRaise);
  set('a-img', p.image);
  set('a-desc', p.description);
  // Compute Actual Available
  const committed = (Array.isArray(p.investments) && p.investments.length) ? p.investments.reduce((s,x)=> s + ((x.status==='approved')?(+x.amount||0):0), 0) : 0;
  const capMax = Math.max(0, Math.floor((+p.price||0) * 0.49));
  const actual = Math.max(0, capMax - committed);
  const actualEl = document.getElementById('a-actual'); if(actualEl) actualEl.value = actual;
  // Update button state after programmatic fill
  updateAddButtonState();
}
function clearForm(){ fillForm({address:'',type:'Single Family',price:'',capRate:'',beds:'',baths:'',sqft:'',totalRaise:'',image:'',description:''}); }
function enterEdit(id){
  const p = listings.find(x=>x.id===id); if(!p) return;
  editingId = id;
  fillForm(p);
  const addBtn=document.getElementById('a-add'); addBtn.textContent=I18N[(localStorage.getItem('lang')||'en')].save;
  const ttl=document.getElementById('a-modal-title'); if(ttl) ttl.textContent='Admin — Update Property';
  renderAdminTable();
  updateAddButtonState();
  openAdminModal();
}
function exitEdit(){
  editingId=null;
  const addBtn=document.getElementById('a-add');
  addBtn.textContent=I18N[(localStorage.getItem('lang')||'en')].add;
  const ttl=document.getElementById('a-modal-title'); if(ttl) ttl.textContent='Admin — Add Property';
  renderAdminTable(); clearForm(); updateAddButtonState();
}
document.getElementById("a-add").onclick=()=>{
  // Validate form and highlight errors
  const fs = {
    address: document.getElementById('a-address'),
    type: document.getElementById('a-type'),
    price: document.getElementById('a-price'),
    cap: document.getElementById('a-cap'),
    beds: document.getElementById('a-beds'),
    baths: document.getElementById('a-baths'),
    sqft: document.getElementById('a-sqft'),
    raise: document.getElementById('a-raise'),
    img: document.getElementById('a-img'),
    desc: document.getElementById('a-desc')
  };
  // Clear previous error styling
  Object.values(fs).forEach(el=>{ if(el){ el.classList.remove('error'); el.removeAttribute('aria-invalid'); } });
  const note = document.getElementById('a-notice');
  function aErr(msg, el){ if(note){ note.style.display='block'; note.textContent=msg; note.setAttribute('role','alert'); }
    if(el){ el.classList.add('error'); el.setAttribute('aria-invalid','true'); el.focus(); }
    return;
  }
  const lang = localStorage.getItem('lang') || 'en';
  const addr = (fs.address?.value||'').trim();
  if(!addr){ aErr(I18N[lang].a_err_address_required, fs.address); return; }
  const typeVal = (fs.type?.value||'').trim();
  if(!typeVal){ aErr(I18N[lang].a_err_type_required, fs.type); return; }
  const priceVal = +((fs.price?.value)||0);
  if(!(priceVal>0)){ aErr(I18N[lang].a_err_price_gt0, fs.price); return; }
  const capStr = (fs.cap?.value||'').trim();
  if(capStr===''){ aErr(I18N[lang].a_err_cap_required, fs.cap); return; }
  if(isNaN(+capStr) || +capStr<0 || +capStr>100){ aErr(I18N[lang].a_err_cap_range, fs.cap); return; }
  const bedsStr = (fs.beds?.value||'').trim(); if(bedsStr===''){ aErr(I18N[lang].a_err_beds_required, fs.beds); return; } if(+bedsStr<0){ aErr(I18N[lang].a_err_beds_nonneg, fs.beds); return; }
  const bathsStr = (fs.baths?.value||'').trim(); if(bathsStr===''){ aErr(I18N[lang].a_err_baths_required, fs.baths); return; } if(+bathsStr<0){ aErr(I18N[lang].a_err_baths_nonneg, fs.baths); return; }
  const sqftStr = (fs.sqft?.value||'').trim(); if(sqftStr===''){ aErr(I18N[lang].a_err_sqft_required, fs.sqft); return; } if(+sqftStr<0){ aErr(I18N[lang].a_err_sqft_nonneg, fs.sqft); return; }
  const raiseStr = (fs.raise?.value||'').trim(); if(raiseStr===''){ aErr(I18N[lang].a_err_raise_required, fs.raise); return; } if(+raiseStr<=0){ aErr(I18N[lang].a_err_raise_gt0, fs.raise); return; }
  const maxRaise = priceVal*0.49;
  if(+raiseStr>maxRaise){ aErr((I18N[lang].a_err_raise_max49||`Total Raise cannot exceed 49% of Price (max ${formatMoney(maxRaise)})`), fs.raise); return; }
  const imgStr = (fs.img?.value||'').trim();
  if(!imgStr){ aErr(I18N[lang].a_err_img_required, fs.img); return; }
  if(!/^https?:\/\//i.test(imgStr) && !imgStr.startsWith('data:')){ aErr(I18N[lang].a_err_img_format, fs.img); return; }
  const descStr = (fs.desc?.value||'').trim(); if(!descStr){ aErr(I18N[lang].a_err_desc_required, fs.desc); return; }

  const g=id=>document.getElementById(id).value;
  const price=priceVal, raise=+(raiseStr||0);
  if(editingId){
    const idx=listings.findIndex(x=>x.id===editingId); if(idx<0) return;
  const newTotal = raise;
    const updated={
      ...listings[idx],
      address:g('a-address'), type:g('a-type'), price,
      capRate:+g('a-cap')||null, beds:+g('a-beds')||0, baths:+g('a-baths')||0, sqft:+g('a-sqft')||0,
  totalRaise:newTotal, image:g('a-img'), description:g('a-desc')
    };
  listings[idx]=updated; saveMockListings(listings); renderAdminTable();
  const noteOK=document.getElementById('a-notice'); if(noteOK){ noteOK.style.display='none'; noteOK.textContent=''; }
  closeAdminModal();
  } else {
    const id="P-"+Math.random().toString(36).slice(2,7).toUpperCase();
  const p={id,ts:Date.now(),address:g("a-address"),type:g("a-type"),price,
             beds:+g("a-beds")||0,baths:+g("a-baths")||0,sqft:+g("a-sqft")||0,
  capRate:+g("a-cap")||null,totalRaise:raise,
  image:g("a-img"),
             description:g("a-desc"),sourceUrl:"#"};
  listings.unshift(p); saveMockListings(listings); renderAdminTable();
  const noteOK=document.getElementById('a-notice'); if(noteOK){ noteOK.style.display='none'; noteOK.textContent=''; }
  closeAdminModal();
  }
};
// Clear error highlighting as user edits fields
function clearAdminFieldError(el){ if(!el) return; el.classList.remove('error'); el.removeAttribute('aria-invalid'); const n=document.getElementById('a-notice'); if(n){ n.style.display='none'; n.textContent=''; } }
["a-address","a-type","a-price","a-cap","a-beds","a-baths","a-sqft","a-raise","a-img","a-desc"].forEach(id=>{
  const el=document.getElementById(id); if(!el) return; const evt = el.tagName === 'SELECT' ? 'change' : 'input';
  el.addEventListener(evt, ()=>{ clearAdminFieldError(el); updateAddButtonState(); });
});
// Keep business rules in sync while editing: raise <= 49% of price
function enforceBusinessRules(){
  const priceEl=document.getElementById('a-price');
  const raiseEl=document.getElementById('a-raise');
  const actualEl=document.getElementById('a-actual');
  if(!priceEl||!raiseEl) return;
  const price=+priceEl.value||0;
  const maxRaise=price*0.49;
  if(+raiseEl.value>maxRaise){ raiseEl.value = Math.floor(maxRaise); }
  // Update Actual Available live (based on current listing context if editing)
  try{
    const id = editingId;
    const p = id ? listings.find(x=>x.id===id) : null;
    const committed = p ? ((Array.isArray(p.investments) && p.investments.length) ? p.investments.reduce((s,x)=> s + ((x.status==='approved')?(+x.amount||0):0), 0) : 0) : 0;
    const capMaxNow = Math.max(0, Math.floor((+priceEl.value||0) * 0.49));
    const actualNow = Math.max(0, capMaxNow - committed);
    if(actualEl) actualEl.value = actualNow;
  }catch(e){}
}
['a-price','a-raise'].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  el.addEventListener('input', ()=>{ enforceBusinessRules(); updateAddButtonState(); });
});
function openAdminModal(){ const m=document.getElementById('a-modal'); if(!m) return; m.classList.add('open'); m.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; setTimeout(()=>{ const first=document.getElementById('a-address'); if(first) first.focus(); }, 30); }
function closeAdminModal(){ const m=document.getElementById('a-modal'); if(!m) return; m.classList.remove('open'); m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; exitEdit(); }
document.getElementById('a-open').onclick=()=>{ exitEdit(); clearForm(); openAdminModal(); };
document.getElementById('a-cancel').onclick=()=>{ closeAdminModal(); };
document.getElementById('a-clear-form').onclick=()=>{ clearForm(); updateAddButtonState(); };
document.getElementById('a-modal-backdrop') && document.getElementById('a-modal-backdrop').addEventListener('click', ()=>{ closeAdminModal(); });
window.addEventListener('keydown', (e)=>{ const m=document.getElementById('a-modal'); if(e.key==='Escape' && m && m.classList.contains('open')){ closeAdminModal(); }});
document.getElementById("a-tbody").addEventListener("click",e=>{
  const t = e.target;
  const actBtn = (t && t.closest) ? t.closest("button[data-action]") : (t && t.parentElement && t.parentElement.closest ? t.parentElement.closest("button[data-action]") : null);
  if(!actBtn) return;
  const id=actBtn.getAttribute("data-id");
  const action=actBtn.getAttribute("data-action");
  if(action==='toggle-sub'){
    const region = document.getElementById(`subrow-${id}`);
    if(region){
      const nowOpen = region.style.display === 'none';
      region.style.display = nowOpen ? 'table-row' : 'none';
      actBtn.setAttribute('aria-expanded', String(nowOpen));
      actBtn.textContent = nowOpen ? (I18N[(localStorage.getItem('lang')||'en')].submissions_hide) : (I18N[(localStorage.getItem('lang')||'en')].submissions_toggle);
    }
    return;
  }
  if(action==='approve'){
    const idx = listings.findIndex(x=>x.id===id); if(idx<0) return;
    const invIndex = +actBtn.getAttribute('data-index');
    const p = listings[idx];
    if(Array.isArray(p.investments) && p.investments[invIndex]){
      p.investments[invIndex].status = 'approved';
      // Recompute committed from approved only, sync legacy fields
      const committed = p.investments.reduce((s,x)=> s + ((x.status==='approved')?(+x.amount||0):0), 0);
      p.totalRaise = committed;
      const capMax = Math.max(0, Math.floor((+p.price||0) * 0.49));
      const actualAvail = Math.max(0, capMax - committed);
      saveMockListings(listings);
      renderAdminTable();
    }
    return;
  }
  if(action==='remove'){
    const it = listings.find(x=>x.id===id);
    const addr = it && it.address ? it.address : id;
    const lang = localStorage.getItem('lang') || 'en';
    const tmpl = I18N[lang] && I18N[lang].a_confirm_remove ? I18N[lang].a_confirm_remove : 'Remove this listing?\n{addr}';
    const msg = tmpl.replace('{addr}', addr);
    if(!confirm(msg)) return;
    if(editingId===id) { exitEdit(); }
    // Move to trash for recovery
  if(it){ trash.unshift(it); saveTrash(); showUndo(I18N[(localStorage.getItem('lang')||'en')].listing_removed, [it]); }
    listings=listings.filter(x=>x.id!==id); saveMockListings(listings); renderAdminTable(); renderTrashTable();
  } else if(action==='edit'){
    enterEdit(id);
  } else if(action==='cancel'){
    exitEdit();
  }
});
function renderTrashTable(){
  const tb=document.getElementById('trash-tbody'); if(!tb) return; tb.innerHTML='';
  trash.forEach(p=>{
    const tr=document.createElement('tr');
    const lang = localStorage.getItem('lang') || 'en';
    tr.innerHTML = `<td>${p.address || p.id}</td><td><button data-id="${p.id}" data-action="restore">${I18N[lang].trash_restore}</button></td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('trash-restore-all').onclick=()=>{
  if(!trash.length) return;
  listings = [...trash, ...listings];
  const restoredIds = new Set(trash.map(x=>x.id));
  // Ensure uniqueness
  listings = listings.filter((x,i,self)=> x && x.id && self.findIndex(y=>y.id===x.id)===i);
  trash = []; saveMockListings(listings); saveTrash();
  renderAdminTable(); renderTrashTable();
};
document.getElementById('trash-empty').onclick=()=>{
  if(!trash.length) return;
  const lang2 = localStorage.getItem('lang') || 'en';
  if(confirm(I18N[lang2].trash_empty_confirm)){ trash = []; saveTrash(); renderTrashTable(); }
};
document.getElementById('trash-tbody').addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('button[data-action="restore"]'); if(!btn) return;
  const id = btn.getAttribute('data-id');
  const idx = trash.findIndex(x=>x.id===id);
  if(idx>-1){
    const item = trash.splice(idx,1)[0];
    listings.unshift(item); saveMockListings(listings); saveTrash();
    renderAdminTable(); renderTrashTable();
  }
});
renderAdminTable();
renderTrashTable();
// Initialize disabled state on load
updateAddButtonState();

// Tooltip behavior for keyboard/click accessibility
document.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('.tooltip .icon-btn');
  if(!btn) return; const wrap = btn.closest('.tooltip'); if(!wrap) return;
  wrap.classList.add('show'); setTimeout(()=>wrap.classList.remove('show'), 1200);
});
document.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter' && e.key !== ' ') return; const el = document.activeElement;
  if(!el) return; const btn = el.closest && el.closest('.tooltip .icon-btn'); if(!btn) return;
  const wrap = btn.closest('.tooltip'); if(!wrap) return; wrap.classList.add('show'); setTimeout(()=>wrap.classList.remove('show'), 1200);
});

// Optional: Google Places Autocomplete for Address
// To enable, serve with an API key restricted to Places Autocomplete and your domain.
// Add your key below or set window.GOOGLE_PLACES_KEY before this script runs.
(function(){
  const KEY = window.GOOGLE_PLACES_KEY || '';
  if(!KEY) return; // No key provided, skip
  const s=document.createElement('script');
  s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(KEY)}&libraries=places&callback=__dreInitPlaces`;
  s.async=true; s.defer=true; document.head.appendChild(s);
  window.__dreInitPlaces = function(){
    const input=document.getElementById('a-address'); if(!input || !window.google || !google.maps || !google.maps.places) return;
    try{
      const country = window.GOOGLE_PLACES_COUNTRY || 'us';
      const ac = new google.maps.places.Autocomplete(input, {
        types: ['address'],
        fields: ['address_components','formatted_address'],
        componentRestrictions: country ? { country } : undefined
      });
      ac.addListener('place_changed', ()=>{
        const place = ac.getPlace();
        if(place && place.formatted_address){
          input.value = place.formatted_address;
          clearAdminFieldError && clearAdminFieldError(input);
          const comps = place.address_components || [];
          const getLong = (t)=>{ const c = comps.find(x=>x.types && x.types.indexOf(t)>=0); return c? c.long_name: ''; };
          const getShort = (t)=>{ const c = comps.find(x=>x.types && x.types.indexOf(t)>=0); return c? c.short_name: ''; };
          const city = getLong('locality') || getLong('sublocality') || getLong('postal_town');
          const state = getShort('administrative_area_level_1');
          const zip = getLong('postal_code');
          const cityEl = document.getElementById('a-city'); if(cityEl){ cityEl.value = city; clearAdminFieldError && clearAdminFieldError(cityEl); }
          const stateEl = document.getElementById('a-state'); if(stateEl){ stateEl.value = state; clearAdminFieldError && clearAdminFieldError(stateEl); }
          const zipEl = document.getElementById('a-zip'); if(zipEl){ zipEl.value = zip; clearAdminFieldError && clearAdminFieldError(zipEl); }
          updateAddButtonState && updateAddButtonState();
        }
      });
    }catch(e){ /* fail silently */ }
  };
})();
</script>
</body>
</html>
