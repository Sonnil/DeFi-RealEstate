<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeFi‚ÄëRealEstate ‚Äî Marketplace</title>
<meta name="description" content="Browse mock real estate listings and reserve allocations via an accessible invest modal.">
<!-- Critical CSS for faster first paint; full stylesheet loads asynchronously -->
<style>
  :root{--bg:#0b0d12;--card:#111623;--text:#e9eef5;--muted:#a9b2c2;--primary:#2e7cf6}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif}
  main{padding:16px}
  .card{background:var(--card);border-radius:12px;padding:20px}
  .muted{color:var(--muted)}
  button.primary{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#1b2133;color:#e9eef5;border:1px solid #2a3550;padding:10px 14px;border-radius:8px;cursor:pointer}
  .property-card{background:#0f1523;border:1px solid #1f2a44;border-radius:12px;overflow:hidden}
  .property-card img{display:block;width:100%;height:180px;object-fit:cover}
  .property-details{padding:12px}
  .property-footer{display:flex;justify-content:space-between;align-items:center}
  @media (max-width:720px){ main{padding:12px} }
  .pill{background:#121a2b;border:1px solid #1f2a44;border-radius:999px;padding:2px 8px}
  .row,.row-2,.row-4{display:grid;gap:10px}
  .row{grid-template-columns:repeat(6,1fr)}
  .row-2{grid-template-columns:repeat(2,1fr)}
  .row-4{grid-template-columns:repeat(4,1fr)}
</style>
<link rel="preload" href="assets/style.min.css?v=4" as="style">
<link rel="stylesheet" href="assets/style.min.css?v=4" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="assets/style.min.css?v=4"></noscript>
</head>
<body>



<main>
  <div class="card">
    <h2 style="margin-top:0" data-i18n="m_title">Marketplace (Demo)</h2>
    <p class="muted" data-i18n="m_desc">Browse mock listings, open the Invest modal, and propose an allocation (min $500).</p>
    <div class="row">
  <div class="field"><label data-i18n="m_search">Search</label><input id="m-search" placeholder="City, address..." data-i18n-placeholder="m_ph_search"></div>
      <div class="field"><label data-i18n="m_type">Type</label>
        <select id="m-type">
          <option value="" data-i18n="any">Any</option>
          <option value="Single Family" data-i18n="type_sf">Single Family</option>
          <option value="Condo" data-i18n="type_con">Condo</option>
          <option value="Townhome" data-i18n="type_th">Townhome</option>
        </select></div>
      <div class="field"><label data-i18n="m_beds">Beds (min)</label><input id="m-beds" type="number" min="0" step="1" placeholder="0"></div>
      <div class="field"><label data-i18n="m_min">Min Price</label><input id="m-min" type="number" min="0" step="10000"></div>
      <div class="field"><label data-i18n="m_max">Max Price</label><input id="m-max" type="number" min="0" step="10000"></div>
      <div class="field"><label data-i18n="m_sort">Sort</label>
        <select id="m-sort">
          <option value="new" data-i18n="sort_new">Newest</option>
          <option value="price_asc" data-i18n="sort_pa">Price ‚Üë</option>
          <option value="price_desc" data-i18n="sort_pd">Price ‚Üì</option>
          <option value="cap_desc" data-i18n="sort_cap">Cap Rate ‚Üì</option>
        </select></div>
    </div>
  </div>
  <div class="cards" id="cards"></div>
</main>

<div class="modal-backdrop" id="mb"></div>
<div class="modal" id="modal">
  <div class="panel">
    <header>
  <h3 id="mod-title" data-i18n="invest_title">Invest</h3>
      <button class="secondary" id="mod-close">‚úï</button>
    </header>
    <div id="mod-body">
  <p class="help" id="mod-help"></p>
      <div class="row-2">
  <div class="field"><label data-i18n="inv_name">Your name</label><input id="inv-name" placeholder="Jane Doe"></div>
  <div class="field"><label data-i18n="inv_amount">Amount ($) ‚Äî min $500</label><input id="inv-amount" type="number" min="500" step="50" value="500"></div>
      </div>
      <div class="row-2">
  <div class="field"><label data-i18n="inv_email_label">Email</label><input id="inv-email" type="email" placeholder="jane@example.com" autocomplete="email"></div>
  <div class="field"><label data-i18n="inv_phone_label">Phone</label><input id="inv-phone" type="tel" inputmode="tel" placeholder="(555) 555-5555" autocomplete="tel"></div>
      </div>
      <div class="row-4">
  <div class="field"><label data-i18n="cc_name_label">Name on Card</label><input id="cc-name" placeholder="Jane A Doe" autocomplete="cc-name"></div>
  <div class="field"><label data-i18n="cc_number_label">Card Number</label><input id="cc-number" inputmode="numeric" pattern="[0-9 ]*" placeholder="4242 4242 4242 4242" autocomplete="cc-number"></div>
  <div class="field"><label data-i18n="cc_exp_label">Expiry (MM/YY)</label><input id="cc-exp" inputmode="numeric" placeholder="MM/YY" autocomplete="cc-exp"></div>
  <div class="field"><label data-i18n="cc_cvc_label">CVC</label><input id="cc-cvc" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="123" autocomplete="cc-csc"></div>
  <div class="field"><label data-i18n="cc_zip_label">ZIP/Postal</label><input id="cc-zip" placeholder="90210" autocomplete="postal-code"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="primary" id="inv-submit" data-i18n="invest">Invest</button>
        <button class="secondary" id="inv-cancel" data-i18n="cancel">Cancel</button>
      </div>
  <p class="help" id="inv-msg" style="margin-top:10px" aria-live="polite" data-i18n="demo_note">Demo only ‚Äî no real payment is processed.</p>
    </div>
  </div>
</div>




<script src="assets/app.min.js?v=6"></script>
<script src="assets/shared.min.js?v=5"></script>
<script src="assets/i18n-extra.js?v=1"></script>
<script>
injectHeaderFooter("market");
let listings = getMockListings();
function renderCards(){
  const q=document.getElementById("m-search").value.trim().toLowerCase();
  const t=document.getElementById("m-type").value;
  const bedsMin=+document.getElementById("m-beds").value||0;
  const minP=+document.getElementById("m-min").value||0;
  const maxP=+document.getElementById("m-max").value||Infinity;
  const sort=document.getElementById("m-sort").value;
  let arr=listings.filter(p=>{
    const okQ=!q||p.address.toLowerCase().includes(q);
    const okT=!t||p.type===t;
    const okB=(p.beds||0)>=bedsMin;
    const okP=(p.price||0)>=minP&&(p.price||0)<=maxP;
    return okQ&&okT&&okB&&okP;
  });
  arr.sort((a,b)=>{
    if(sort==="price_asc")return a.price-b.price;
    if(sort==="price_desc")return b.price-a.price;
    if(sort==="cap_desc")return (b.capRate||0)-(a.capRate||0);
    return (b.ts||0)-(a.ts||0);
  });
  const cards=document.getElementById("cards"); cards.innerHTML="";
  const lang=localStorage.getItem("lang")||"en";
  const tAvail=I18N[lang].available, tRaise=I18N[lang].raise;
  arr.forEach(p=>{
    const el=document.createElement("div");
    el.className="property-card";
    el.innerHTML=`
      <img src="${p.image||''}" alt="property" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">
      <div class="property-details">
        <h3>${p.address}</h3>
        <div class="property-meta">
          <span>${p.type||'‚Äî'}</span>
          <span>üõè ${p.beds||0}</span>
          <span>üõÅ ${p.baths||0}</span>
          <span>üìê ${(p.sqft||0).toLocaleString()} sqft</span>
          <span>üíπ ${(p.capRate??'‚Äî')}% cap</span>
        </div>
        <div class="property-footer">
          <div>
            <div style="font-weight:800">${formatMoney(p.price)}</div>
            <div class="muted"><span class="pill">${tRaise}: ${formatMoney(p.totalRaise)}</span></div>
            <div class="muted"><span class="pill">${tAvail}: <strong>${formatMoney(p.availableRaise)}</strong></span></div>
          </div>
          <button class="primary" data-id="${p.id}" data-action="invest">${I18N[lang].invest}</button>
        </div>
      </div>`;
    cards.appendChild(el);
  });
}
renderCards();

let currentListingId=null; const mb=document.getElementById("mb"), modal=document.getElementById("modal");
function openInvest(id){
  const p=listings.find(x=>x.id===id); if(!p)return;
  currentListingId=id;
  const lang=localStorage.getItem('lang')||'en';
  document.getElementById("mod-title").textContent=`${I18N[lang].invest_title} ‚Äî ${p.address}`;
  document.getElementById("mod-help").textContent=`${formatMoney(p.availableRaise)} ${I18N[lang].available_short}`;
  document.getElementById("inv-name").value="";
  document.getElementById("inv-amount").value=500;
  document.getElementById("inv-email").value="";
  document.getElementById("inv-phone").value="";
  document.getElementById("cc-name").value="";
  document.getElementById("cc-number").value="";
  document.getElementById("cc-exp").value="";
  document.getElementById("cc-cvc").value="";
  document.getElementById("cc-zip").value="";
  document.getElementById("inv-msg").textContent="";
  openModal('modal','mb');
}
function closeInvest(){ closeModal('modal','mb'); }
document.getElementById("cards").addEventListener("click",e=>{
  const btn=e.target.closest("button[data-action='invest']"); if(btn){ openInvest(btn.getAttribute("data-id")); }
});
document.getElementById("mod-close").onclick=closeInvest;
document.getElementById("inv-cancel").onclick=closeInvest;
mb.onclick=closeInvest;

// Use shared helpers from assets/shared.min.js: onlyDigits, luhnCheck, validExpiry, formatCardNumber
document.getElementById("inv-submit").onclick=()=>{
  const vals = {
    name: document.getElementById("inv-name").value.trim(),
    amount: +document.getElementById("inv-amount").value || 0,
    email: document.getElementById("inv-email").value.trim(),
    phone: document.getElementById("inv-phone").value.trim(),
    ccName: document.getElementById("cc-name").value.trim(),
    ccNumber: document.getElementById("cc-number").value.trim(),
    ccExp: document.getElementById("cc-exp").value.trim(),
    ccCvc: document.getElementById("cc-cvc").value.trim(),
    ccZip: document.getElementById("cc-zip").value.trim()
  };
  const msgEl=document.getElementById("inv-msg");
  const lang=localStorage.getItem("lang")||"en";
  const fields = {
    name: document.getElementById('inv-name'),
    amount: document.getElementById('inv-amount'),
    email: document.getElementById('inv-email'),
    phone: document.getElementById('inv-phone'),
    ccName: document.getElementById('cc-name'),
    ccNumber: document.getElementById('cc-number'),
    ccExp: document.getElementById('cc-exp'),
    ccCvc: document.getElementById('cc-cvc'),
    ccZip: document.getElementById('cc-zip')
  };
  // clear previous error styling
  Object.values(fields).forEach(el=>{ el.classList.remove('error'); el.removeAttribute('aria-invalid'); });
  function flag(el){ if(!el) return; el.classList.add('error'); el.setAttribute('aria-invalid','true'); el.focus(); }
  function err(t, el){ if(el) flag(el); msgEl.textContent=t; }

  if(!vals.name) return err(I18N[lang].err_name_required, fields.name);
  if(vals.amount < 500) return err(I18N[lang].err_min_amount, fields.amount);
  const idx=listings.findIndex(x=>x.id===currentListingId); if(idx<0) return;
  if(vals.amount > listings[idx].availableRaise) return err(I18N[lang].err_exceeds_available, fields.amount);
  // Contact validation
  const emailOk = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(vals.email);
  if(!emailOk) return err(I18N[lang].err_email, fields.email);
  const phoneDigits = onlyDigits(vals.phone);
  if(phoneDigits.length < 7) return err(I18N[lang].err_phone, fields.phone);
  // Card validation (basic)
  if(!vals.ccName) return err(I18N[lang].err_cc_name, fields.ccName);
  if(!luhnCheck(vals.ccNumber)) return err(I18N[lang].err_cc_number, fields.ccNumber);
  if(!validExpiry(vals.ccExp)) return err(I18N[lang].err_cc_exp, fields.ccExp);
  if(!/^\d{3,4}$/.test(vals.ccCvc)) return err(I18N[lang].err_cc_cvc, fields.ccCvc);
  if(vals.ccZip.length < 3) return err(I18N[lang].err_cc_zip, fields.ccZip);

  // Simulate success, no real payment processed
  listings[idx].availableRaise -= vals.amount;
  saveMockListings(listings);
  renderCards();
  msgEl.textContent = I18N[lang].success_reserved;
  setTimeout(closeInvest,1100);
};

// Prefill Name on Card when typing name (if empty)
document.getElementById("inv-name").addEventListener('input', function(){
  const ccNameEl = document.getElementById('cc-name');
  if(ccNameEl && !ccNameEl.value) ccNameEl.value = this.value;
});

// Format card number and expiry as the user types
document.getElementById('cc-number').addEventListener('input', (e)=>{
  e.target.value = formatCardNumber(e.target.value);
});
document.getElementById('cc-exp').addEventListener('input', (e)=>{
  let s = onlyDigits(e.target.value).slice(0,4);
  if(s.length > 2) s = s.slice(0,2) + '/' + s.slice(2);
  e.target.value = s;
});

["m-search","m-type","m-beds","m-min","m-max","m-sort"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderCards);
});
</script>
</body>
</html>
