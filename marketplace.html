<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeFi‚ÄëRealEstate ‚Äî Marketplace</title>
<meta name="description" content="Browse mock real estate listings and reserve allocations via an accessible invest modal.">
<!-- Critical CSS for faster first paint; full stylesheet loads asynchronously -->
<style>
  /* keep only small page-specific helpers; remove dark theme overrides */
  main{padding:16px}
  .card{border-radius:12px;padding:20px}
  .muted{opacity:.9}
  /* Wider panel locally for invest form */
  #modal .panel{width:min(720px,100%)}
  /* Two-column form grid on desktop; stacks on mobile */
  .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .form-grid .span-2{grid-column:span 2}
  .row,.row-2,.row-4{display:grid;gap:10px}
  .row{grid-template-columns:repeat(6,1fr)}
  .row-2{grid-template-columns:repeat(2,1fr)}
  .row-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:720px){ main{padding:12px} }
  @media (max-width:720px){ .form-grid{grid-template-columns:1fr} .form-grid .span-2{grid-column:span 1} }
  .icon-btn{background:transparent;border:0;color:inherit;cursor:pointer;padding:0 2px}
  .icon-btn:hover{filter:brightness(1.1)}
  /* Tooltip bubble (local override to ensure correct behavior in Marketplace) */
  .tooltip{position:relative;display:inline-block}
  /* Prevent white highlight from global chip styles on nested tooltip wrapper */
  .property-meta .tooltip{background:transparent !important;border:0 !important;padding:0 !important}
  .tooltip .tip{position:absolute;z-index:1000;left:50%;transform:translateX(-50%);bottom:125%;background:#0e1526;color:#e9eef5;border:1px solid #2a3550;border-radius:8px;padding:8px 10px;white-space:normal;font-size:12px;line-height:1.3;min-width:180px;max-width:260px;box-shadow:0 10px 30px rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .16s ease,transform .16s ease}
  .tooltip .tip::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);border-width:6px;border-style:solid;border-color:#0e1526 transparent transparent transparent}
  .tooltip:hover .tip,.tooltip:focus-within .tip,.tooltip.show .tip{opacity:1;pointer-events:auto;transform:translate(-50%,-2px)}
  .tooltip .tip [role="heading"]{font-weight:600;margin:0 0 4px}
  @media (prefers-reduced-motion: reduce){ .tooltip .tip{transition:none} }
</style>
<link rel="preload" href="assets/style.min.css?v=6" as="style">
<link rel="stylesheet" href="assets/style.min.css?v=6" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="assets/style.min.css?v=6"></noscript>
</head>
<body>



<main>
  <div class="card">
    <h2 style="margin-top:0" data-i18n="m_title">Marketplace (Demo)</h2>
    <p class="muted" data-i18n="m_desc">Browse mock listings, open the Invest modal, and propose an allocation (min $500).</p>
    <div class="row">
  <div class="field"><label data-i18n="m_search">Search</label><input id="m-search" placeholder="City, address..." data-i18n-placeholder="m_ph_search"></div>
      <div class="field"><label data-i18n="m_type">Type</label>
        <select id="m-type">
          <option value="" data-i18n="any">Any</option>
          <option value="Single Family" data-i18n="type_sf">Single Family</option>
          <option value="Condo" data-i18n="type_con">Condo</option>
          <option value="Townhome" data-i18n="type_th">Townhome</option>
        </select></div>
      <div class="field"><label data-i18n="m_beds">Beds (min)</label><input id="m-beds" type="number" min="0" step="1" placeholder="0"></div>
      <div class="field"><label data-i18n="m_min">Min Price</label><input id="m-min" type="number" min="0" step="10000"></div>
      <div class="field"><label data-i18n="m_max">Max Price</label><input id="m-max" type="number" min="0" step="10000"></div>
      <div class="field"><label data-i18n="m_sort">Sort</label>
        <select id="m-sort">
          <option value="new" data-i18n="sort_new">Newest</option>
          <option value="price_asc" data-i18n="sort_pa">Price ‚Üë</option>
          <option value="price_desc" data-i18n="sort_pd">Price ‚Üì</option>
          <option value="cap_desc" data-i18n="sort_cap">Cap Rate ‚Üì</option>
        </select></div>
    </div>
  </div>
  <div class="cards" id="cards"></div>
</main>

<div class="modal-backdrop" id="mb"></div>
<div class="modal" id="modal">
  <div class="panel">
    <header>
  <h3 id="mod-title" data-i18n="invest_title">Invest</h3>
      <button class="secondary" id="mod-close">‚úï</button>
    </header>
    <div id="mod-body">
  <p class="help" id="mod-help"></p>
      <div class="form-grid">
        <div class="field"><label data-i18n="inv_name">Your name</label><input id="inv-name" placeholder="Jane Doe"></div>
        <div class="field"><label data-i18n="inv_amount">Amount ($) ‚Äî min $500</label><input id="inv-amount" type="number" min="500" step="50" value="500"></div>
        <div class="field"><label data-i18n="inv_email_label">Email</label><input id="inv-email" type="email" placeholder="jane@example.com" autocomplete="email"></div>
        <div class="field"><label data-i18n="inv_phone_label">Phone</label><input id="inv-phone" type="tel" inputmode="tel" placeholder="(555) 555-5555" autocomplete="tel"></div>
        <div class="field"><label data-i18n="cc_name_label">Name on Card</label><input id="cc-name" placeholder="Jane A Doe" autocomplete="cc-name"></div>
        <div class="field"><label data-i18n="cc_number_label">Card Number</label><input id="cc-number" inputmode="numeric" pattern="[0-9 ]*" placeholder="4242 4242 4242 4242" autocomplete="cc-number"></div>
        <div class="field"><label data-i18n="cc_exp_label">Expiry (MM/YY)</label><input id="cc-exp" inputmode="numeric" placeholder="MM/YY" autocomplete="cc-exp"></div>
        <div class="field"><label data-i18n="cc_cvc_label">CVC</label><input id="cc-cvc" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="123" autocomplete="cc-csc"></div>
        <div class="field span-2"><label data-i18n="cc_zip_label">ZIP/Postal</label><input id="cc-zip" placeholder="90210" autocomplete="postal-code"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="primary" id="inv-submit" data-i18n="invest">Invest</button>
        <button class="secondary" id="inv-cancel" data-i18n="cancel">Cancel</button>
      </div>
  <p class="help" id="inv-msg" style="margin-top:10px" aria-live="polite" data-i18n="demo_note">Demo only ‚Äî no real payment is processed.</p>
    </div>
  </div>
</div>




<script src="assets/app.min.js?v=6"></script>
<script src="assets/shared.min.js?v=5"></script>
<script src="assets/i18n-extra.js?v=2"></script>
<script>
injectHeaderFooter("market");
let listings = getMockListings();
function renderCards(){
  const q=document.getElementById("m-search").value.trim().toLowerCase();
  const t=document.getElementById("m-type").value;
  const bedsMin=+document.getElementById("m-beds").value||0;
  const minP=+document.getElementById("m-min").value||0;
  const maxP=+document.getElementById("m-max").value||Infinity;
  const sort=document.getElementById("m-sort").value;
  let arr=listings.filter(p=>{
    const okQ=!q||p.address.toLowerCase().includes(q);
    const okT=!t||p.type===t;
    const okB=(p.beds||0)>=bedsMin;
    const okP=(p.price||0)>=minP&&(p.price||0)<=maxP;
    return okQ&&okT&&okB&&okP;
  });
  arr.sort((a,b)=>{
    if(sort==="price_asc")return a.price-b.price;
    if(sort==="price_desc")return b.price-a.price;
    if(sort==="cap_desc")return (b.capRate||0)-(a.capRate||0);
    return (b.ts||0)-(a.ts||0);
  });
  const cards=document.getElementById("cards"); cards.innerHTML="";
  const lang=localStorage.getItem("lang")||"en";
  const tAvail=I18N[lang].available, tRaise=I18N[lang].raise;
  arr.forEach(p=>{
    const el=document.createElement("div");
    el.className="property-card";
  const avail = +p.availableRaise || 0;
  const hideInvest = avail < 500;
  el.innerHTML=`
      <img src="${p.image||''}" alt="property" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">
        <div class="property-details">
        <h3>${p.address}</h3>
        <div class="property-meta">
          <span>${p.type||'‚Äî'}</span>
          <span>üõè ${p.beds||0}</span>
          <span>üõÅ ${p.baths||0}</span>
          <span>üìê ${(p.sqft||0).toLocaleString()} sqft</span>
          <span>üíπ ${(p.capRate??'‚Äî')}% cap 
            <span class="tooltip">
              <button type="button" class="icon-btn" aria-label="What is Cap Rate?" data-i18n-aria-label="info_cap_label">‚ÑπÔ∏è</button>
              <span class="tip" role="tooltip"><span role="heading" data-i18n="info_cap_label">What is Cap Rate?</span><span data-i18n="info_cap">Cap rate = Net Operating Income (NOI) √∑ Purchase Price. Rough annual yield before financing and taxes.</span></span>
            </span>
          </span>
        </div>
        <div class="property-footer">
          <div>
            <div style="font-weight:800;display:flex;align-items:center;gap:6px">
              <span>${formatMoney(p.price)}</span>
              <span class="tooltip">
                <button type="button" class="icon-btn" aria-label="What is Price?" data-i18n-aria-label="info_price_label" style="font-weight:normal">‚ÑπÔ∏è</button>
                <span class="tip" role="tooltip"><span role="heading" data-i18n="info_price_label">What is Price?</span><span data-i18n="info_price">The estimated purchase price or offering price for the property.</span></span>
              </span>
            </div>
            <div class="muted" style="display:flex;align-items:center;gap:6px">
              <span class="pill">${tRaise}: ${formatMoney(p.totalRaise)}</span>
            </div>
            <div class="muted" style="display:flex;align-items:center;gap:6px">
              <span class="pill">${tAvail}: <strong>${formatMoney(p.availableRaise)}</strong></span>
            </div>
          </div>
            ${hideInvest
              ? `<span class="pill" aria-label="Fullying Invested">üéâ Fullying Invested</span>`
              : `<button class="primary" data-id="${p.id}" data-action="invest">${I18N[lang].invest}</button>`}
        </div>
      </div>`;
    cards.appendChild(el);
  });
}
renderCards();
// Tooltip behavior: toggle .show briefly on click/focus for keyboard users with fade
document.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('.tooltip .icon-btn');
  if(!btn) return;
  const wrap = btn.closest('.tooltip'); if(!wrap) return;
  wrap.classList.add('show');
  setTimeout(()=>wrap.classList.remove('show'), 1200);
});
document.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter' && e.key !== ' ') return;
  const btn = document.activeElement && document.activeElement.closest && document.activeElement.closest('.tooltip .icon-btn');
  if(!btn) return;
  const wrap = btn.closest('.tooltip'); if(!wrap) return;
  wrap.classList.add('show');
  setTimeout(()=>wrap.classList.remove('show'), 1200);
});

let currentListingId=null; const mb=document.getElementById("mb"), modal=document.getElementById("modal");
function openInvest(id){
  const p=listings.find(x=>x.id===id); if(!p)return;
  currentListingId=id;
  const lang=localStorage.getItem('lang')||'en';
  document.getElementById("mod-title").textContent=`${I18N[lang].invest_title} ‚Äî ${p.address}`;
  const avail = +p.availableRaise||0;
  if(avail<=0){
    document.getElementById("mod-help").textContent = I18N[lang].fully_invested || 'Fully invested';
  } else {
    document.getElementById("mod-help").textContent = `${formatMoney(avail)} ${I18N[lang].available_short}`;
  }
  document.getElementById("inv-name").value="";
  document.getElementById("inv-amount").value = Math.min(500, Math.max(0, avail));
  const submitBtn = document.getElementById("inv-submit");
  submitBtn.disabled = avail<=0; submitBtn.setAttribute('aria-disabled', String(avail<=0));
  document.getElementById("inv-email").value="";
  document.getElementById("inv-phone").value="";
  document.getElementById("cc-name").value="";
  document.getElementById("cc-number").value="";
  document.getElementById("cc-exp").value="";
  document.getElementById("cc-cvc").value="";
  document.getElementById("cc-zip").value="";
  document.getElementById("inv-msg").textContent="";
  openModal('modal','mb');
}
function closeInvest(){ closeModal('modal','mb'); }
document.getElementById("cards").addEventListener("click",e=>{
  const btn=e.target.closest("button[data-action='invest']"); if(btn){ openInvest(btn.getAttribute("data-id")); }
});
document.getElementById("mod-close").onclick=closeInvest;
document.getElementById("inv-cancel").onclick=closeInvest;
mb.onclick=closeInvest;

// Use shared helpers from assets/shared.min.js: onlyDigits, luhnCheck, validExpiry, formatCardNumber
document.getElementById("inv-submit").onclick=()=>{
  const vals = {
    name: document.getElementById("inv-name").value.trim(),
    amount: +document.getElementById("inv-amount").value || 0,
    email: document.getElementById("inv-email").value.trim(),
    phone: document.getElementById("inv-phone").value.trim(),
    ccName: document.getElementById("cc-name").value.trim(),
    ccNumber: document.getElementById("cc-number").value.trim(),
    ccExp: document.getElementById("cc-exp").value.trim(),
    ccCvc: document.getElementById("cc-cvc").value.trim(),
    ccZip: document.getElementById("cc-zip").value.trim()
  };
  const msgEl=document.getElementById("inv-msg");
  const lang=localStorage.getItem("lang")||"en";
  const fields = {
    name: document.getElementById('inv-name'),
    amount: document.getElementById('inv-amount'),
    email: document.getElementById('inv-email'),
    phone: document.getElementById('inv-phone'),
    ccName: document.getElementById('cc-name'),
    ccNumber: document.getElementById('cc-number'),
    ccExp: document.getElementById('cc-exp'),
    ccCvc: document.getElementById('cc-cvc'),
    ccZip: document.getElementById('cc-zip')
  };
  // clear previous error styling
  Object.values(fields).forEach(el=>{ el.classList.remove('error'); el.removeAttribute('aria-invalid'); });
  function flag(el){ if(!el) return; el.classList.add('error'); el.setAttribute('aria-invalid','true'); el.focus(); }
  function err(t, el){ if(el) flag(el); msgEl.textContent=t; }

  if(!vals.name) return err(I18N[lang].err_name_required, fields.name);
  if(vals.amount < 500) return err(I18N[lang].err_min_amount, fields.amount);
  const idx=listings.findIndex(x=>x.id===currentListingId); if(idx<0) return;
  const availNow = +listings[idx].availableRaise||0;
  if(availNow<=0){ return err(I18N[lang].fully_invested || 'Fully invested'); }
  if(vals.amount > availNow){
    const msgTmpl = I18N[lang].err_max_amount_tmpl || 'Maximum investment is {max}';
    return err(msgTmpl.replace('{max}', formatMoney(availNow)), fields.amount);
  }
  // Contact validation
  const emailOk = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(vals.email);
  if(!emailOk) return err(I18N[lang].err_email, fields.email);
  const phoneDigits = onlyDigits(vals.phone);
  if(phoneDigits.length < 7) return err(I18N[lang].err_phone, fields.phone);
  // Card validation (basic)
  if(!vals.ccName) return err(I18N[lang].err_cc_name, fields.ccName);
  if(!luhnCheck(vals.ccNumber)) return err(I18N[lang].err_cc_number, fields.ccNumber);
  if(!validExpiry(vals.ccExp)) return err(I18N[lang].err_cc_exp, fields.ccExp);
  if(!/^\d{3,4}$/.test(vals.ccCvc)) return err(I18N[lang].err_cc_cvc, fields.ccCvc);
  if(vals.ccZip.length < 3) return err(I18N[lang].err_cc_zip, fields.ccZip);

  // Simulate success, no real payment processed
  listings[idx].availableRaise -= vals.amount;
  saveMockListings(listings);
  renderCards();
  msgEl.textContent = I18N[lang].success_reserved;
  setTimeout(closeInvest,1100);
};

// Prefill Name on Card when typing name (if empty)
document.getElementById("inv-name").addEventListener('input', function(){
  const ccNameEl = document.getElementById('cc-name');
  if(ccNameEl && !ccNameEl.value) ccNameEl.value = this.value;
});

// Format card number and expiry as the user types
document.getElementById('cc-number').addEventListener('input', (e)=>{
  e.target.value = formatCardNumber(e.target.value);
});
document.getElementById('cc-exp').addEventListener('input', (e)=>{
  let s = onlyDigits(e.target.value).slice(0,4);
  if(s.length > 2) s = s.slice(0,2) + '/' + s.slice(2);
  e.target.value = s;
});

["m-search","m-type","m-beds","m-min","m-max","m-sort"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderCards);
});
</script>
</body>
</html>
