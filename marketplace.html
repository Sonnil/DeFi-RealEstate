<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeFiâ€‘RealEstate â€” Marketplace</title>
<meta name="description" content="Browse mock real estate listings and reserve allocations via an accessible invest modal.">
<link rel="stylesheet" href="assets/style.min.css?v=4" />
</head>
<body>



<main>
  <div class="card">
    <h2 style="margin-top:0" data-i18n="m_title">Marketplace (Demo)</h2>
    <p class="muted" data-i18n="m_desc">Browse mock listings, open the Invest modal, and propose an allocation (min $500).</p>
    <div class="row">
      <div class="field"><label data-i18n="m_search">Search</label><input id="m-search" placeholder="City, address..."></div>
      <div class="field"><label data-i18n="m_type">Type</label>
        <select id="m-type">
          <option value="" data-i18n="any">Any</option>
          <option value="Single Family" data-i18n="type_sf">Single Family</option>
          <option value="Condo" data-i18n="type_con">Condo</option>
          <option value="Townhome" data-i18n="type_th">Townhome</option>
        </select></div>
      <div class="field"><label data-i18n="m_beds">Beds (min)</label><input id="m-beds" type="number" min="0" step="1" placeholder="0"></div>
      <div class="field"><label data-i18n="m_min">Min Price</label><input id="m-min" type="number" min="0" step="10000"></div>
      <div class="field"><label data-i18n="m_max">Max Price</label><input id="m-max" type="number" min="0" step="10000"></div>
      <div class="field"><label data-i18n="m_sort">Sort</label>
        <select id="m-sort">
          <option value="new" data-i18n="sort_new">Newest</option>
          <option value="price_asc" data-i18n="sort_pa">Price â†‘</option>
          <option value="price_desc" data-i18n="sort_pd">Price â†“</option>
          <option value="cap_desc" data-i18n="sort_cap">Cap Rate â†“</option>
        </select></div>
    </div>
  </div>
  <div class="cards" id="cards"></div>
</main>

<div class="modal-backdrop" id="mb"></div>
<div class="modal" id="modal">
  <div class="panel">
    <header>
      <h3 id="mod-title">Invest</h3>
      <button class="secondary" id="mod-close">âœ•</button>
    </header>
    <div id="mod-body">
      <p class="help" id="mod-help"></p>
      <div class="row-2">
        <div class="field"><label data-i18n="inv_name">Your name</label><input id="inv-name" placeholder="Jane Doe"></div>
        <div class="field"><label data-i18n="inv_amount">Amount ($) â€” min $500</label><input id="inv-amount" type="number" min="500" step="50" value="500"></div>
      </div>
      <div class="row-2">
        <div class="field"><label>Email</label><input id="inv-email" type="email" placeholder="jane@example.com" autocomplete="email"></div>
        <div class="field"><label>Phone</label><input id="inv-phone" type="tel" inputmode="tel" placeholder="(555) 555-5555" autocomplete="tel"></div>
      </div>
      <div class="row-4">
        <div class="field"><label>Name on Card</label><input id="cc-name" placeholder="Jane A Doe" autocomplete="cc-name"></div>
        <div class="field"><label>Card Number</label><input id="cc-number" inputmode="numeric" pattern="[0-9 ]*" placeholder="4242 4242 4242 4242" autocomplete="cc-number"></div>
        <div class="field"><label>Expiry (MM/YY)</label><input id="cc-exp" inputmode="numeric" placeholder="MM/YY" autocomplete="cc-exp"></div>
        <div class="field"><label>CVC</label><input id="cc-cvc" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="123" autocomplete="cc-csc"></div>
        <div class="field"><label>ZIP/Postal</label><input id="cc-zip" placeholder="90210" autocomplete="postal-code"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="primary" id="inv-submit" data-i18n="invest">Invest</button>
        <button class="secondary" id="inv-cancel" data-i18n="cancel">Cancel</button>
      </div>
      <p class="help" id="inv-msg" style="margin-top:10px" aria-live="polite">Demo only â€” no real payment is processed.</p>
    </div>
  </div>
</div>




<script src="assets/app.min.js?v=2"></script>
<script src="assets/shared.min.js?v=3"></script>
<script>
injectHeaderFooter("market");
let listings = getMockListings();
function renderCards(){
  const q=document.getElementById("m-search").value.trim().toLowerCase();
  const t=document.getElementById("m-type").value;
  const bedsMin=+document.getElementById("m-beds").value||0;
  const minP=+document.getElementById("m-min").value||0;
  const maxP=+document.getElementById("m-max").value||Infinity;
  const sort=document.getElementById("m-sort").value;
  let arr=listings.filter(p=>{
    const okQ=!q||p.address.toLowerCase().includes(q);
    const okT=!t||p.type===t;
    const okB=(p.beds||0)>=bedsMin;
    const okP=(p.price||0)>=minP&&(p.price||0)<=maxP;
    return okQ&&okT&&okB&&okP;
  });
  arr.sort((a,b)=>{
    if(sort==="price_asc")return a.price-b.price;
    if(sort==="price_desc")return b.price-a.price;
    if(sort==="cap_desc")return (b.capRate||0)-(a.capRate||0);
    return (b.ts||0)-(a.ts||0);
  });
  const cards=document.getElementById("cards"); cards.innerHTML="";
  const lang=localStorage.getItem("lang")||"en";
  const tAvail=I18N[lang].available, tRaise=I18N[lang].raise;
  arr.forEach(p=>{
    const el=document.createElement("div");
    el.className="property-card";
    el.innerHTML=`
      <img src="${p.image||''}" alt="property" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">
      <div class="property-details">
        <h3>${p.address}</h3>
        <div class="property-meta">
          <span>${p.type||'â€”'}</span>
          <span>ğŸ› ${p.beds||0}</span>
          <span>ğŸ› ${p.baths||0}</span>
          <span>ğŸ“ ${(p.sqft||0).toLocaleString()} sqft</span>
          <span>ğŸ’¹ ${(p.capRate??'â€”')}% cap</span>
        </div>
        <div class="property-footer">
          <div>
            <div style="font-weight:800">${formatMoney(p.price)}</div>
            <div class="muted"><span class="pill">${tRaise}: ${formatMoney(p.totalRaise)}</span></div>
            <div class="muted"><span class="pill">${tAvail}: <strong>${formatMoney(p.availableRaise)}</strong></span></div>
          </div>
          <button class="primary" data-id="${p.id}" data-action="invest">${I18N[lang].invest}</button>
        </div>
      </div>`;
    cards.appendChild(el);
  });
}
renderCards();

let currentListingId=null; const mb=document.getElementById("mb"), modal=document.getElementById("modal");
function openInvest(id){
  const p=listings.find(x=>x.id===id); if(!p)return;
  currentListingId=id;
  document.getElementById("mod-title").textContent=`Invest â€” ${p.address}`;
  document.getElementById("mod-help").textContent=`${formatMoney(p.availableRaise)} available`;
  document.getElementById("inv-name").value="";
  document.getElementById("inv-amount").value=500;
  document.getElementById("inv-email").value="";
  document.getElementById("inv-phone").value="";
  document.getElementById("cc-name").value="";
  document.getElementById("cc-number").value="";
  document.getElementById("cc-exp").value="";
  document.getElementById("cc-cvc").value="";
  document.getElementById("cc-zip").value="";
  document.getElementById("inv-msg").textContent="";
  openModal('modal','mb');
}
function closeInvest(){ closeModal('modal','mb'); }
document.getElementById("cards").addEventListener("click",e=>{
  const btn=e.target.closest("button[data-action='invest']"); if(btn){ openInvest(btn.getAttribute("data-id")); }
});
document.getElementById("mod-close").onclick=closeInvest;
document.getElementById("inv-cancel").onclick=closeInvest;
mb.onclick=closeInvest;

// Use shared helpers from assets/shared.min.js: onlyDigits, luhnCheck, validExpiry, formatCardNumber
document.getElementById("inv-submit").onclick=()=>{
  const vals = {
    name: document.getElementById("inv-name").value.trim(),
    amount: +document.getElementById("inv-amount").value || 0,
    email: document.getElementById("inv-email").value.trim(),
    phone: document.getElementById("inv-phone").value.trim(),
    ccName: document.getElementById("cc-name").value.trim(),
    ccNumber: document.getElementById("cc-number").value.trim(),
    ccExp: document.getElementById("cc-exp").value.trim(),
    ccCvc: document.getElementById("cc-cvc").value.trim(),
    ccZip: document.getElementById("cc-zip").value.trim()
  };
  const msgEl=document.getElementById("inv-msg");
  const lang=localStorage.getItem("lang")||"en";
  const fields = {
    name: document.getElementById('inv-name'),
    amount: document.getElementById('inv-amount'),
    email: document.getElementById('inv-email'),
    phone: document.getElementById('inv-phone'),
    ccName: document.getElementById('cc-name'),
    ccNumber: document.getElementById('cc-number'),
    ccExp: document.getElementById('cc-exp'),
    ccCvc: document.getElementById('cc-cvc'),
    ccZip: document.getElementById('cc-zip')
  };
  // clear previous error styling
  Object.values(fields).forEach(el=>{ el.classList.remove('error'); el.removeAttribute('aria-invalid'); });
  function flag(el){ if(!el) return; el.classList.add('error'); el.setAttribute('aria-invalid','true'); el.focus(); }
  function err(t, el){ if(el) flag(el); msgEl.textContent=t; }

  if(!vals.name) return err(lang==="vi"?"Vui lÃ²ng nháº­p tÃªn.":"Please enter your name.", fields.name);
  if(vals.amount < 500) return err(lang==="vi"?"Tá»‘i thiá»ƒu $500.":"Minimum is $500.", fields.amount);
  const idx=listings.findIndex(x=>x.id===currentListingId); if(idx<0) return;
  if(vals.amount > listings[idx].availableRaise) return err(lang==="vi"?"VÆ°á»£t quÃ¡ sá»‘ vá»‘n cÃ²n má»Ÿ.":"Exceeds available amount.", fields.amount);
  // Contact validation
  const emailOk = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(vals.email);
  if(!emailOk) return err("Please enter a valid email.", fields.email);
  const phoneDigits = onlyDigits(vals.phone);
  if(phoneDigits.length < 7) return err("Please enter a valid phone number.", fields.phone);
  // Card validation (basic)
  if(!vals.ccName) return err("Please enter name on card.", fields.ccName);
  if(!luhnCheck(vals.ccNumber)) return err("Card number looks invalid.", fields.ccNumber);
  if(!validExpiry(vals.ccExp)) return err("Expiry must be MM/YY and not in the past.", fields.ccExp);
  if(!/^\d{3,4}$/.test(vals.ccCvc)) return err("CVC must be 3â€“4 digits.", fields.ccCvc);
  if(vals.ccZip.length < 3) return err("Please enter a valid ZIP/Postal code.", fields.ccZip);

  // Simulate success, no real payment processed
  listings[idx].availableRaise -= vals.amount;
  saveMockListings(listings);
  renderCards();
  msgEl.textContent = (lang==="vi"?"ÄÄƒng kÃ½ thÃ nh cÃ´ng!":"Allocation reserved! (Demo â€” no card charged)");
  setTimeout(closeInvest,1100);
};

// Prefill Name on Card when typing name (if empty)
document.getElementById("inv-name").addEventListener('input', function(){
  const ccNameEl = document.getElementById('cc-name');
  if(ccNameEl && !ccNameEl.value) ccNameEl.value = this.value;
});

// Format card number and expiry as the user types
document.getElementById('cc-number').addEventListener('input', (e)=>{
  e.target.value = formatCardNumber(e.target.value);
});
document.getElementById('cc-exp').addEventListener('input', (e)=>{
  let s = onlyDigits(e.target.value).slice(0,4);
  if(s.length > 2) s = s.slice(0,2) + '/' + s.slice(2);
  e.target.value = s;
});

["m-search","m-type","m-beds","m-min","m-max","m-sort"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderCards);
});
</script>
</body>
</html>
